<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manim Video Viewer</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: "Roboto", Arial, sans-serif; background: #0f0f0f; color: #fff; height: 100vh; overflow: hidden; }
        .container { display: flex; height: 100vh; gap: 12px; padding: 24px; }
        .video-section { flex: 1; min-width: 0; }
        .video-wrapper { height: 100%; background: #000; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; position: relative; }
        video { flex: 1; width: 100%; object-fit: contain; cursor: pointer; }

        /* Progress bar */
        .progress-bar { position: absolute; bottom: 40px; left: 12px; right: 12px; height: 20px; cursor: pointer; z-index: 10; display: flex; align-items: center; }
        .progress-track { width: 100%; height: 3px; background: #0f0f0f; display: flex; gap: 3px; border-radius: 2px; overflow: hidden; transition: height 0.1s; }
        .progress-bar:hover .progress-track { height: 5px; }
        .chapter-segment { height: 100%; background: rgba(255,255,255,0.3); }
        .chapter-segment-fill { height: 100%; background: #f00; width: 0; }
        .progress-dot { position: absolute; top: 50%; width: 13px; height: 13px; background: #f00; border-radius: 50%; transform: translateY(-50%) scale(0); transition: transform 0.1s; pointer-events: none; }
        .progress-bar:hover .progress-dot, .progress-bar.dragging .progress-dot { transform: translateY(-50%) scale(1); }

        /* Controls */
        .controls { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: linear-gradient(transparent, rgba(0,0,0,0.9)); position: absolute; bottom: 0; left: 0; right: 0; }
        .play-btn, .ctrl-btn { background: transparent; border: none; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .play-btn { width: 40px; height: 40px; border-radius: 50%; }
        .ctrl-btn { width: 36px; height: 36px; border-radius: 4px; }
        .play-btn:hover, .ctrl-btn:hover { background: rgba(255,255,255,0.1); }
        .play-btn svg, .ctrl-btn svg { width: 24px; height: 24px; fill: #fff; }
        .ctrl-btn svg { width: 20px; height: 20px; }
        .ctrl-btn.active { background: rgba(255,255,255,0.2); }
        .time { font-size: 13px; margin-left: 4px; }
        .time .sep { color: #aaa; margin: 0 4px; }
        .spacer { flex: 1; }

        /* Subtitle overlay */
        .subtitle-overlay { position: absolute; bottom: 70px; left: 50%; transform: translateX(-50%); text-align: center; pointer-events: none; max-width: 80%; z-index: 5; }
        .subtitle-text { background: rgba(0,0,0,0.75); color: #fff; padding: 6px 16px; border-radius: 4px; display: inline-block; font-family: Arial, sans-serif; line-height: 1.4; }
        .subtitle-text:empty { display: none; }
        .subtitle-text.size-small { font-size: 16px; }
        .subtitle-text.size-medium { font-size: 24px; }
        .subtitle-text.size-large { font-size: 36px; }

        /* Dropdown menus */
        .menu-wrap { position: relative; }
        .dropdown-menu { position: absolute; bottom: 100%; right: 0; background: #212121; border-radius: 8px; padding: 8px 0; min-width: 140px; display: none; box-shadow: 0 4px 16px rgba(0,0,0,0.5); margin-bottom: 8px; z-index: 20; }
        .dropdown-menu.open { display: block; }
        .dropdown-menu.settings { min-width: 180px; }
        .menu-opt { padding: 8px 16px; cursor: pointer; font-size: 14px; display: flex; align-items: center; }
        .menu-opt:hover { background: rgba(255,255,255,0.1); }
        .menu-opt .check { width: 20px; margin-right: 4px; opacity: 0; }
        .menu-opt.active .check { opacity: 1; }
        .menu-opt .arrow { margin-left: auto; font-size: 12px; color: #aaa; }
        .menu-divider { height: 1px; background: #3f3f3f; margin: 8px 0; }
        .submenu { position: absolute; left: -100%; bottom: 0; background: #212121; border-radius: 8px; padding: 8px 0; min-width: 140px; display: none; box-shadow: 0 4px 16px rgba(0,0,0,0.5); }
        .submenu.open { display: block; }

        /* Download modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 100; }
        .modal-overlay.open { display: flex; }
        .modal { background: #212121; border-radius: 12px; padding: 24px; min-width: 320px; }
        .modal h3 { font-size: 18px; margin-bottom: 16px; }
        .modal-opts { display: flex; flex-direction: column; gap: 8px; }
        .modal-opt { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: #2a2a2a; border-radius: 8px; cursor: pointer; border: 2px solid transparent; }
        .modal-opt:hover { border-color: #3f3f3f; }
        .modal-opt.selected { border-color: #1E88E5; }
        .modal-opt .info { flex: 1; }
        .modal-opt .label { font-size: 14px; font-weight: 500; }
        .modal-opt .desc { font-size: 12px; color: #aaa; margin-top: 2px; }
        .modal-opt .radio { width: 18px; height: 18px; border: 2px solid #666; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .modal-opt.selected .radio { border-color: #1E88E5; }
        .modal-opt.selected .radio::after { content: ''; width: 10px; height: 10px; background: #1E88E5; border-radius: 50%; }
        .modal-btns { display: flex; gap: 12px; margin-top: 20px; justify-content: flex-end; }
        .modal-btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; }
        .modal-btn.cancel { background: #3f3f3f; color: #fff; }
        .modal-btn.cancel:hover { background: #4f4f4f; }
        .modal-btn.primary { background: #1E88E5; color: #fff; }
        .modal-btn.primary:hover { background: #1976D2; }
        .modal-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .modal-progress { margin-top: 16px; display: none; }
        .modal-progress.show { display: block; }
        .modal-progress .bar { height: 4px; background: #3f3f3f; border-radius: 2px; overflow: hidden; }
        .modal-progress .fill { height: 100%; background: #1E88E5; width: 0; transition: width 0.3s; }
        .modal-progress .status { font-size: 12px; color: #aaa; margin-top: 8px; }

        /* Chapter dropdown */
        .chapter-dropdown-container { position: relative; }
        .scene-name { font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 300px; cursor: pointer; }
        .scene-name:hover { color: #aaa; }
        .scene-name::after { content: ' ▼'; font-size: 10px; }
        .chapter-dropdown { position: absolute; bottom: 100%; left: 0; background: #212121; border-radius: 8px; padding: 8px 0; min-width: 260px; display: none; box-shadow: 0 4px 16px rgba(0,0,0,0.5); margin-bottom: 8px; z-index: 20; max-height: 300px; overflow-y: auto; }
        .chapter-dropdown.open { display: block; }
        .chapter-dropdown::-webkit-scrollbar { width: 8px; }
        .chapter-dropdown::-webkit-scrollbar-thumb { background: #3f3f3f; border-radius: 4px; }
        .chapter-item { padding: 10px 16px; cursor: pointer; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        .chapter-item:hover { background: rgba(255,255,255,0.1); }
        .chapter-item.active { background: rgba(255,255,255,0.15); }
        .chapter-item .ch-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
        .chapter-item .ch-time { color: #aaa; font-size: 12px; margin-left: 12px; }

        /* Resizer */
        .resizer { width: 6px; background: transparent; cursor: col-resize; position: relative; flex-shrink: 0; margin: 0 -3px; z-index: 10; }
        .resizer::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 4px; height: 40px; background: #3f3f3f; border-radius: 2px; opacity: 0; transition: opacity 0.2s; }
        .resizer:hover::after, .resizer.active::after { opacity: 1; }
        .resizer:hover, .resizer.active { background: rgba(30, 136, 229, 0.2); }
        body.resizing { cursor: col-resize; user-select: none; }
        body.resizing video, body.resizing .feedback-panel { pointer-events: none; }

        /* Feedback panel */
        .feedback-panel { width: 320px; min-width: 200px; max-width: 600px; display: flex; flex-direction: column; overflow: hidden; background: #181818; border-radius: 12px; padding: 16px; }
        .feedback-panel h3 { font-size: 16px; font-weight: 500; margin-bottom: 16px; }
        .feedback-input-row { display: flex; gap: 8px; align-items: center; margin: 16px 0; }
        .feedback-timestamp { background: #272727; padding: 8px 12px; border-radius: 6px; font-size: 14px; font-family: monospace; min-width: 60px; text-align: center; }
        .feedback-input { flex: 1; background: #272727; border: none; color: #fff; padding: 8px 12px; border-radius: 6px; font-size: 14px; outline: none; }
        .feedback-input:focus { box-shadow: 0 0 0 2px #1E88E5; }
        .feedback-input::placeholder { color: #666; }
        .feedback-add-btn { background: #238636; border: none; color: #fff; width: 36px; height: 36px; border-radius: 6px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; }
        .feedback-add-btn:hover { background: #2ea043; }
        .feedback-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
        .feedback-list::-webkit-scrollbar { width: 8px; }
        .feedback-list::-webkit-scrollbar-thumb { background: #3f3f3f; border-radius: 4px; }
        .feedback-item { background: #272727; padding: 10px 12px; border-radius: 8px; position: relative; }
        .feedback-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .feedback-item-time { font-size: 12px; color: #1E88E5; font-family: monospace; }
        .feedback-item-scene { font-size: 12px; color: #aaa; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 180px; }
        .feedback-item-delete { background: none; border: none; color: #666; cursor: pointer; font-size: 16px; padding: 0 4px; }
        .feedback-item-delete:hover { color: #f44; }
        .feedback-item-text { font-size: 14px; }
        .feedback-empty { color: #666; font-size: 14px; text-align: center; padding: 40px 20px; }
        .feedback-actions { display: flex; gap: 8px; }
        .feedback-btn { flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; }
        .feedback-btn.copy { background: #1E88E5; color: #fff; }
        .feedback-btn.copy:hover { background: #1976D2; }
        .feedback-btn.copy.copied { background: #238636; }
        .feedback-btn.clear { background: #3f3f3f; color: #fff; }
        .feedback-btn.clear:hover { background: #4f4f4f; }
        .feedback-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .shortcuts { font-size: 12px; color: #aaa; padding: 12px 0; border-top: 1px solid #3f3f3f; margin-top: auto; }
        .shortcuts kbd { background: #272727; padding: 3px 8px; border-radius: 4px; font-family: inherit; font-size: 11px; margin-right: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="feedback-panel">
            <h3>Feedback</h3>
            <div class="feedback-list" id="feedbackList">
                <div class="feedback-empty">No feedback yet. Add comments as you watch.</div>
            </div>
            <div class="feedback-input-row">
                <span class="feedback-timestamp" id="feedbackTimestamp">@0:00</span>
                <input type="text" class="feedback-input" id="feedbackInput" placeholder="Add comment...">
                <button class="feedback-add-btn" id="feedbackAddBtn">+</button>
            </div>
            <div class="feedback-actions">
                <button class="feedback-btn copy" id="copyAllBtn" disabled>Copy All</button>
                <button class="feedback-btn clear" id="clearAllBtn" disabled>Clear</button>
            </div>
            <div class="shortcuts"><kbd>Space</kbd> Play/Pause <kbd>C</kbd> Subtitles <kbd>F</kbd> Add feedback</div>
        </div>
        <div class="resizer" id="resizer"></div>
        <div class="video-section">
            <div class="video-wrapper">
                <video id="video" src="/video.mp4"></video>
                <div class="subtitle-overlay"><div class="subtitle-text size-medium" id="subtitleText"></div></div>
                <div class="progress-bar" id="progressBar">
                    <div class="progress-track" id="progressTrack"></div>
                    <div class="progress-dot" id="progressDot"></div>
                </div>
                <div class="controls">
                    <button class="play-btn" id="playBtn">
                        <svg id="playIcon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        <svg id="pauseIcon" viewBox="0 0 24 24" hidden><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                        <svg id="replayIcon" viewBox="0 0 24 24" hidden><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>
                    </button>
                    <div class="time"><span id="curTime">0:00</span><span class="sep">/</span><span id="durTime">0:00</span></div>
                    <div class="chapter-dropdown-container">
                        <div class="scene-name" id="sceneName">-</div>
                        <div class="chapter-dropdown" id="chapterDropdown"></div>
                    </div>
                    <div class="spacer"></div>
                    <button class="ctrl-btn" id="ccBtn" title="Subtitles" hidden>
                        <svg viewBox="0 0 24 24"><path d="M19 4H5c-1.11 0-2 .9-2 2v12c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-8 7H9.5v-.5h-2v3h2V13H11v1c0 .55-.45 1-1 1H7c-.55 0-1-.45-1-1v-4c0-.55.45-1 1-1h3c.55 0 1 .45 1 1v1zm7 0h-1.5v-.5h-2v3h2V13H18v1c0 .55-.45 1-1 1h-3c-.55 0-1-.45-1-1v-4c0-.55.45-1 1-1h3c.55 0 1 .45 1 1v1z"/></svg>
                    </button>
                    <div class="menu-wrap">
                        <button class="ctrl-btn" id="settingsBtn" title="Settings">
                            <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                        </button>
                        <div class="dropdown-menu settings" id="settingsMenu">
                            <div class="menu-opt" data-submenu="fontSizeMenu"><span>Subtitle size</span><span class="arrow">›</span></div>
                            <div class="submenu" id="fontSizeMenu">
                                <div class="menu-opt" data-size="small"><span class="check">✓</span>Small</div>
                                <div class="menu-opt active" data-size="medium"><span class="check">✓</span>Medium</div>
                                <div class="menu-opt" data-size="large"><span class="check">✓</span>Large</div>
                            </div>
                            <div class="menu-divider"></div>
                            <div class="menu-opt" data-submenu="speedMenu"><span>Playback speed</span><span class="arrow">›</span></div>
                            <div class="submenu" id="speedMenu"></div>
                        </div>
                    </div>
                    <button class="ctrl-btn" id="downloadBtn" title="Download">
                        <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="downloadModal">
        <div class="modal">
            <h3>Download video</h3>
            <div class="modal-opts">
                <div class="modal-opt selected" data-quality="low">
                    <div class="radio"></div>
                    <div class="info"><div class="label">Low quality (480p)</div><div class="desc">Current preview, instant download</div></div>
                </div>
                <div class="modal-opt" data-quality="high">
                    <div class="radio"></div>
                    <div class="info"><div class="label">High quality (1080p)</div><div class="desc">Re-renders, may take a few minutes</div></div>
                </div>
            </div>
            <div class="modal-progress" id="downloadProgress">
                <div class="bar"><div class="fill" id="progressFill"></div></div>
                <div class="status" id="progressStatus">Preparing...</div>
            </div>
            <div class="modal-btns">
                <button class="modal-btn cancel" id="downloadCancel">Cancel</button>
                <button class="modal-btn primary" id="downloadConfirm">Download</button>
            </div>
        </div>
    </div>
<script>
const $ = id => document.getElementById(id);
const video = $('video'), progressBar = $('progressBar'), settingsMenu = $('settingsMenu'), downloadModal = $('downloadModal');

let chapters = [], subtitles = [], feedbackItems = [];
let ended = false, dragging = false, subtitlesOn = false;

const fmt = s => `${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`;
const getChapter = t => chapters.findLast(c => t >= c.start) || chapters[0];
const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
const seekBy = delta => { video.currentTime = clamp(video.currentTime + delta, 0, video.duration); ended = false; updateUI(); };

function parseSRT(text) {
    return text.trim().split(/\n\n+/).map(block => {
        const lines = block.split('\n');
        const m = lines[1]?.match(/(\d{2}):(\d{2}):(\d{2})[,.](\d{3})\s*-->\s*(\d{2}):(\d{2}):(\d{2})[,.](\d{3})/);
        return m ? { start: +m[1]*3600 + +m[2]*60 + +m[3] + +m[4]/1000, end: +m[5]*3600 + +m[6]*60 + +m[7] + +m[8]/1000, text: lines.slice(2).join('\n') } : null;
    }).filter(Boolean);
}

function updateUI() {
    const t = video.currentTime, d = video.duration || 1, ch = getChapter(t);
    $('curTime').textContent = fmt(t);
    $('durTime').textContent = fmt(d);
    $('feedbackTimestamp').textContent = '@' + fmt(t);
    $('sceneName').textContent = ch?.name || '-';
    document.querySelectorAll('.chapter-item').forEach((el, i) => el.classList.toggle('active', i === ch?.index));

    // Play button icon
    $('playIcon').style.display = !ended && video.paused ? 'block' : 'none';
    $('pauseIcon').style.display = !ended && !video.paused ? 'block' : 'none';
    $('replayIcon').style.display = ended ? 'block' : 'none';

    // Progress bar
    chapters.forEach((c, i) => {
        const fill = document.querySelector(`.chapter-segment[data-i="${i}"] .chapter-segment-fill`);
        if (fill) fill.style.width = t >= c.start + c.duration ? '100%' : t > c.start ? `${(t - c.start) / c.duration * 100}%` : '0';
    });
    $('progressDot').style.left = `calc(${t / d * 100}% - 6px)`;

    // Subtitles
    const sub = subtitlesOn && subtitles.find(s => t >= s.start && t < s.end);
    $('subtitleText').textContent = sub ? sub.text : '';
}

function renderFeedback() {
    const list = $('feedbackList'), hasItems = feedbackItems.length > 0;
    list.innerHTML = hasItems
        ? feedbackItems.map((f, i) => `<div class="feedback-item"><div class="feedback-item-header"><span class="feedback-item-time">[${f.time}]</span><span class="feedback-item-scene">${f.scene}</span><button class="feedback-item-delete" data-i="${i}">&times;</button></div><div class="feedback-item-text">${f.comment}</div></div>`).join('')
        : '<div class="feedback-empty">No feedback yet. Add comments as you watch.</div>';
    $('copyAllBtn').disabled = $('clearAllBtn').disabled = !hasItems;
}

function addFeedback() {
    const input = $('feedbackInput'), comment = input.value.trim();
    if (!comment) return;
    feedbackItems.push({ time: fmt(video.currentTime), scene: getChapter(video.currentTime)?.name || 'Unknown', comment });
    input.value = '';
    renderFeedback();
}

function copyFeedback() {
    navigator.clipboard.writeText('═══ VIDEO FEEDBACK ═══\n' + feedbackItems.map(f => `[${f.time}] ${f.scene}: ${f.comment}`).join('\n') + '\n═══════════════════════');
    const btn = $('copyAllBtn');
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'Copy All'; btn.classList.remove('copied'); }, 1500);
}

function togglePlay() {
    if (ended) { video.currentTime = 0; ended = false; }
    video.paused ? video.play() : video.pause();
}

function seek(e) {
    video.currentTime = clamp((e.clientX - progressBar.getBoundingClientRect().left) / progressBar.offsetWidth, 0, 1) * video.duration;
    ended = false;
    updateUI();
}

async function downloadVideo(quality) {
    $('downloadConfirm').disabled = true;
    $('downloadProgress').classList.add('show');
    $('progressFill').style.width = '0%';
    $('progressStatus').textContent = quality === 'high' ? 'Re-rendering...' : 'Preparing...';

    const checkInterval = quality === 'high' && setInterval(async () => {
        const res = await fetch('/download/status').catch(() => null);
        if (res?.ok) { const s = await res.json(); $('progressFill').style.width = s.progress + '%'; $('progressStatus').textContent = s.message; }
    }, 1000);

    try {
        const res = await fetch('/download?quality=' + quality);
        if (checkInterval) clearInterval(checkInterval);
        if (!res.ok) throw new Error('Download failed');
        $('progressFill').style.width = '100%';
        $('progressStatus').textContent = 'Ready!';
        const blob = await res.blob(), a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = res.headers.get('X-Filename') || 'video.mp4';
        a.click();
        URL.revokeObjectURL(a.href);
        setTimeout(() => downloadModal.classList.remove('open'), 500);
    } catch (e) {
        if (checkInterval) clearInterval(checkInterval);
        $('progressStatus').textContent = 'Error: ' + e.message;
        $('downloadConfirm').disabled = false;
    }
}

async function init() {
    chapters = await (await fetch('/chapters.json')).json();
    try { const res = await fetch('/subtitles.srt'); if (res.ok) subtitles = parseSRT(await res.text()); } catch {}

    $('chapterDropdown').innerHTML = chapters.map(c => `<div class="chapter-item" data-t="${c.start}"><span class="ch-name">${c.name}</span><span class="ch-time">${fmt(c.start)}</span></div>`).join('');
    $('progressTrack').innerHTML = chapters.map((c, i) => `<div class="chapter-segment" data-i="${i}" style="flex-grow:${c.duration}"><div class="chapter-segment-fill"></div></div>`).join('');
    $('speedMenu').innerHTML = [0.5, 0.75, 1, 1.25, 1.5, 2].map(s => `<div class="menu-opt${s === 1 ? ' active' : ''}" data-speed="${s}"><span class="check">✓</span>${s === 1 ? 'Normal' : s + 'x'}</div>`).join('');
    if (subtitles.length) $('ccBtn').hidden = false;

    // Video events
    video.addEventListener('timeupdate', updateUI);
    video.addEventListener('play', () => { ended = false; updateUI(); });
    video.addEventListener('pause', updateUI);
    video.addEventListener('ended', () => { ended = true; updateUI(); });
    video.addEventListener('loadedmetadata', () => $('durTime').textContent = fmt(video.duration));
    video.addEventListener('click', togglePlay);
    $('playBtn').addEventListener('click', togglePlay);

    // Progress bar drag
    progressBar.addEventListener('mousedown', e => { dragging = true; progressBar.classList.add('dragging'); seek(e); });
    document.addEventListener('mousemove', e => dragging && seek(e));
    document.addEventListener('mouseup', () => dragging && (dragging = false, progressBar.classList.remove('dragging')));

    // Document-level click handlers (close dropdowns)
    const closeMenus = () => settingsMenu.querySelectorAll('.open').forEach(el => el.classList.remove('open')) || settingsMenu.classList.remove('open');
    document.addEventListener('click', e => {
        if (!e.target.closest('.chapter-dropdown-container')) $('chapterDropdown').classList.remove('open');
        closeMenus();
    });

    // Chapter dropdown
    $('sceneName').addEventListener('click', e => { e.stopPropagation(); $('chapterDropdown').classList.toggle('open'); });
    $('chapterDropdown').addEventListener('click', e => {
        const ch = e.target.closest('.chapter-item');
        if (ch) { video.currentTime = +ch.dataset.t; ended = false; updateUI(); $('chapterDropdown').classList.remove('open'); }
    });

    // Feedback
    $('feedbackAddBtn').addEventListener('click', addFeedback);
    $('feedbackInput').addEventListener('keydown', e => e.key === 'Enter' && addFeedback());
    $('feedbackList').addEventListener('click', e => { const btn = e.target.closest('[data-i]'); if (btn) { feedbackItems.splice(+btn.dataset.i, 1); renderFeedback(); } });
    $('copyAllBtn').addEventListener('click', copyFeedback);
    $('clearAllBtn').addEventListener('click', () => { feedbackItems = []; renderFeedback(); });

    // CC toggle
    $('ccBtn').addEventListener('click', () => { subtitlesOn = !subtitlesOn; $('ccBtn').classList.toggle('active', subtitlesOn); updateUI(); });

    // Settings menu
    $('settingsBtn').addEventListener('click', e => { e.stopPropagation(); settingsMenu.classList.toggle('open'); });
    settingsMenu.addEventListener('mouseover', e => { const opt = e.target.closest('[data-submenu]'); if (opt) { settingsMenu.querySelectorAll('.submenu').forEach(s => s.classList.remove('open')); $(opt.dataset.submenu).classList.add('open'); } });
    $('fontSizeMenu').addEventListener('click', e => { const opt = e.target.closest('[data-size]'); if (opt) { $('subtitleText').className = 'subtitle-text size-' + opt.dataset.size; $('fontSizeMenu').querySelectorAll('.menu-opt').forEach(el => el.classList.toggle('active', el.dataset.size === opt.dataset.size)); closeMenus(); } });
    $('speedMenu').addEventListener('click', e => { const opt = e.target.closest('[data-speed]'); if (opt) { video.playbackRate = +opt.dataset.speed; $('speedMenu').querySelectorAll('.menu-opt').forEach(el => el.classList.toggle('active', el.dataset.speed === opt.dataset.speed)); closeMenus(); } });

    // Download modal
    let selectedQuality = 'low';
    $('downloadBtn').addEventListener('click', () => { downloadModal.classList.add('open'); $('downloadProgress').classList.remove('show'); $('downloadConfirm').disabled = false; });
    $('downloadCancel').addEventListener('click', () => downloadModal.classList.remove('open'));
    downloadModal.addEventListener('click', e => e.target === downloadModal && downloadModal.classList.remove('open'));
    downloadModal.querySelectorAll('.modal-opt').forEach(opt => opt.addEventListener('click', () => { downloadModal.querySelectorAll('.modal-opt').forEach(o => o.classList.remove('selected')); opt.classList.add('selected'); selectedQuality = opt.dataset.quality; }));
    $('downloadConfirm').addEventListener('click', () => downloadVideo(selectedQuality));

    // Keyboard shortcuts
    document.addEventListener('keydown', e => {
        if (e.target.tagName === 'INPUT' || downloadModal.classList.contains('open')) return;
        const actions = { Space: togglePlay, KeyK: togglePlay, ArrowLeft: () => seekBy(-5), KeyJ: () => seekBy(-5), ArrowRight: () => seekBy(5), KeyL: () => seekBy(5), KeyC: () => subtitles.length && $('ccBtn').click(), KeyF: () => $('feedbackInput').focus() };
        if (actions[e.code]) { e.preventDefault(); actions[e.code](); }
    });

    // Panel resizer
    const resizer = $('resizer'), feedbackPanel = document.querySelector('.feedback-panel');
    let resizing = false;
    resizer.addEventListener('mousedown', e => {
        resizing = true;
        resizer.classList.add('active');
        document.body.classList.add('resizing');
        e.preventDefault();
    });
    document.addEventListener('mousemove', e => {
        if (!resizing) return;
        const containerRect = document.querySelector('.container').getBoundingClientRect();
        const newWidth = e.clientX - containerRect.left - 24; // 24px padding
        feedbackPanel.style.width = clamp(newWidth, 200, 600) + 'px';
    });
    document.addEventListener('mouseup', () => {
        if (resizing) {
            resizing = false;
            resizer.classList.remove('active');
            document.body.classList.remove('resizing');
        }
    });

    updateUI();
}
init();
</script>
</body>
</html>
